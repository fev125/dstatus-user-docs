# 通知设置页面

## 页面路径
管理后台 → 通知设置（`/admin/notification`）

## 页面功能
- 配置 Telegram 和邮件通知渠道
- 管理通知类型开关
- 创建自定义通知任务
- 测试通知配置

## 页面布局

### 通知类型管理
统一管理所有通知渠道的通知类型开关：
- **服务器上线**：服务器恢复在线时发送通知
- **服务器下线**：服务器离线时发送通知
- **流量超限**：服务器流量超过阈值时发送通知
- **测试通知**：测试通知功能
- **状态汇总**：定期发送状态汇总报告
- **新服务器发现**：自动发现新服务器时发送通知
- **服务器审批**：服务器审批通过时发送通知

### Telegram 通知设置
配置 Telegram Bot 通知：
- **启用开关**：开启/关闭 Telegram 通知
- **Bot 令牌**：Telegram Bot 的认证令牌（从 @BotFather 获取）
- **Chat IDs**：接收通知的用户ID或频道用户名（多个用逗号分隔）
- **高级设置**：
  - Webhook 模式（实验性功能）
  - Webhook 端口
  - API Base URL（默认：https://api.telegram.org）
  - 离线通知延迟（秒，默认300秒）
  - 流量阈值（%，默认80,90,95）

### 邮件通知设置
配置 SMTP 邮件通知：
- **启用开关**：开启/关闭邮件通知
- **SMTP 服务器**：邮件服务器地址（如 smtp.gmail.com）
- **端口**：SMTP 端口（如 587）
- **安全连接**：启用 SSL/TLS 加密
- **认证信息**：用户名和密码（建议使用应用专用密码）
- **发件人信息**：发件人邮箱地址和名称
- **收件人配置**：
  - To（收件人）：必需，多个用逗号分隔
  - CC（抄送）：可选
  - BCC（密送）：可选

### 自定义通知任务
配置服务器流量监控和自定义通知规则：
- **任务列表**：显示所有自定义通知任务
- **任务统计**：总任务数、已启用、已禁用、服务器数量
- **创建任务**：创建新的通知任务
- **任务筛选**：按服务器、状态、周期筛选
- **批量操作**：批量启用、禁用、删除任务

## 操作步骤

### 配置 Telegram 通知
1. 点击"Telegram 通知设置"卡片展开配置
2. 开启"启用 Telegram 通知"开关
3. **获取 Bot 令牌**：
   - 打开 Telegram，搜索 @BotFather
   - 发送 `/newbot` 创建新 Bot
   - 保存收到的 Bot 令牌
4. **获取 Chat ID**：
   - 个人用户：搜索 @getidbot 获取个人 Chat ID
   - 频道/群组：将 Bot 添加到群组，向 Bot 发送消息后使用 getUpdates API 获取
5. **填写配置**：
   - 在"Bot 令牌"字段粘贴令牌
   - 在"Chat IDs"字段输入 Chat ID（多个用逗号分隔）
6. **高级设置**（可选）：
   - 点击"高级设置"展开
   - 配置 Webhook 模式、端口、API 地址等
7. 点击"保存配置"保存设置
8. 点击"发送测试"验证配置是否正常

### 配置邮件通知
1. 点击"邮件通知设置"卡片展开配置
2. 开启"启用邮件通知"开关
3. **填写 SMTP 信息**：
   - SMTP 服务器：输入邮件服务器地址（如 smtp.gmail.com）
   - 端口：输入端口号（如 587）
   - 启用"安全连接"（SSL/TLS）
4. **填写认证信息**：
   - 用户名：邮箱地址
   - 密码：应用专用密码（Gmail 等需要）
5. **填写发件人信息**：
   - 发件人邮箱：用于发送通知的邮箱地址
   - 发件人名称：显示名称（可选）
6. **配置收件人**：
   - 收件人（To）：必需，多个用逗号分隔
   - 抄送（CC）：可选
   - 密送（BCC）：可选
7. 点击"保存配置"保存设置
8. 点击"发送测试"验证配置是否正常
9. 点击"查看日志"查看邮件发送历史

### 管理通知类型
1. 在"通知类型管理"区域查看所有通知类型
2. 表格显示每个通知类型在 Telegram 和邮件渠道的开关状态
3. **切换通知类型**：
   - 勾选/取消勾选对应渠道的复选框
   - 支持批量操作（点击类型名称旁的按钮）
4. 修改后点击"保存类型开关"保存设置

### 创建自定义通知任务
1. 点击"自定义通知任务"卡片展开
2. 点击"创建任务"按钮
3. **填写任务信息**：
   - 选择服务器
   - 设置通知类型和触发条件
   - 配置通知周期（每日/每周/每月）
4. **启用任务**：
   - 创建后默认启用
   - 可在任务列表中禁用/启用
5. 保存任务

## 常见问题

### Telegram 测试失败
**可能原因**：
- Bot 令牌无效或已过期
- Chat ID 错误
- 服务器无法访问 api.telegram.org

**解决方法**：
1. 重新从 @BotFather 获取 Bot 令牌
2. 使用 @getidbot 重新获取 Chat ID
3. 检查服务器网络连接和防火墙设置

### 邮件测试失败
**可能原因**：
- SMTP 认证失败
- 端口或服务器地址错误
- 使用了账户密码而非应用专用密码

**解决方法**：
1. 检查 SMTP 服务器地址和端口是否正确
2. Gmail 用户：使用应用专用密码而非账户密码
3. 确认"安全连接"选项已启用
4. 查看邮件日志了解具体错误信息

### 通知未收到
**可能原因**：
- 通知类型未启用
- 通知渠道未配置或未启用
- 触发条件未满足

**解决方法**：
1. 检查"通知类型管理"中对应类型是否已启用
2. 确认 Telegram 或邮件通知已正确配置并启用
3. 点击"发送测试"验证通知渠道是否正常
4. 查看系统日志确认通知是否已发送
