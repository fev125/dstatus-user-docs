# 高级设置页面

## 📍 页面路径
管理后台 → 高级设置（`/admin/advanced-settings`）

## 🎯 页面功能
- 性能优化配置（性能模式切换、轮询间隔、WebSocket间隔）
- PostgreSQL数据库配置（启用/禁用、连接配置、数据迁移）
- 存储管理（容量概览、预警阈值、数据保留策略、维护操作）
- 数据清理管理（清理历史数据、系统日志）

## 📋 页面布局

### 性能与数据管理
- **性能模式切换**：节能、平衡、高性能三种预设模式，用于快速设置轮询间隔和WebSocket推送间隔
- **轮询间隔**：服务器查询探针的间隔时间（1.5-60秒），影响监控数据更新的频率
- **WebSocket间隔**：WebSocket推送更新的间隔时间（1.5-60秒），影响前端页面数据刷新的频率
- **数据保留策略**：配置不同层级数据的保留时长

### PostgreSQL数据库配置
- **启用/禁用开关**：启用PostgreSQL读取优化
- **连接配置**：主机、端口、数据库名、用户名、密码
- **连接字符串快速配置**：从连接字符串自动填入表单
- **测试连接**：验证PostgreSQL连接是否正常
- **数据迁移**：手动触发SQLite数据迁移到PostgreSQL

### 存储管理
- **容量概览**：数据库大小、日均增长、服务器数量
- **存储预警阈值**：容量预警、增长预警、通知冷却期
- **数据保留策略**：TCPing、负载监控、带宽统计、AI报告
- **维护操作**：刷新状态、干跑清理、执行清理、优化数据库
- **表空间占比**：各表和索引的估算大小
- **任务状态**：维护任务进度和历史记录

### 数据清理管理
- **清理时间范围**：选择清理多少天前的数据（7/15/30/60/90天）
- **数据类型选择**：选择要清理的数据类型
  - TCPing监控数据（分钟级、5分钟级、小时级、天级、月级、归档）
  - Load负载数据（分钟级、小时级、归档）
  - Traffic流量数据
  - 系统日志（审计日志等）

## 🔧 操作步骤

### 性能模式切换
1. 在"性能与数据管理"卡片中选择性能模式：
   - **节能模式**：轮询间隔10秒，WebSocket间隔12秒，降低资源占用
   - **平衡模式**：轮询间隔3秒，WebSocket间隔4秒，日常监控推荐值（默认）
   - **高性能模式**：轮询间隔1.5秒，WebSocket间隔2秒，提升实时性
2. 性能模式会立即写入配置，自动设置对应的轮询间隔和WebSocket推送间隔。
3. 性能模式影响的是服务器查询探针的频率和前端数据推送的频率。节点过多且不需要高精度实时监控时，建议使用平衡模式以降低系统资源消耗。

### 手动调整轮询间隔
1. 在"性能与数据管理"卡片中找到"轮询间隔"设置
2. 输入新的间隔值（1.5-60秒）
3. 点击"保存设置"按钮
4. 设置立即生效，建议重启服务以获得最佳性能

### 配置PostgreSQL数据库
1. 在"PostgreSQL数据库配置"卡片中，打开"启用PostgreSQL"开关
2. 填写连接信息：
   - **主机地址**：PostgreSQL服务器地址（如 `localhost` 或 `192.168.1.100`）
   - **端口**：PostgreSQL端口（默认 `5432`）
   - **数据库名**：数据库名称（如 `dstatus`）
   - **用户名**：PostgreSQL用户名
   - **密码**：PostgreSQL密码
3. **可选**：使用连接字符串快速配置
   - 在"快速配置"框中输入连接字符串（格式：`postgresql://username:password@host:port/database`）
   - 点击"解析填入"按钮自动填充表单
4. 点击"测试连接"按钮验证连接是否正常
5. 点击"保存配置"按钮保存配置
6. 配置保存后需要重启应用才能生效

### 执行数据迁移
1. 确保PostgreSQL已配置并启用
2. 在"PostgreSQL数据库配置"卡片中点击"开始迁移"按钮
3. 迁移进度会显示在"数据迁移进度"区域
4. 等待迁移完成（可能需要较长时间，取决于数据量）
5. 迁移完成后，PostgreSQL会自动生效

### 配置存储预警阈值
1. 在"存储管理"区域找到"存储预警阈值"卡片
2. 设置以下阈值：
   - **容量预警阈值**：数据库大小超过此值时触发通知（100-10000 MB）
   - **增长预警阈值**：日均增长超过此值时触发通知（10-500 MB/天）
   - **通知冷却期**：两次相同类型通知之间的最小间隔时间（10-1440 分钟）
3. 点击"保存阈值配置"按钮

### 配置数据保留策略
1. 在"存储管理"区域找到"数据保留策略"卡片
2. 配置不同数据类型的保留时长：
   - **TCPing数据**：实时数据（小时）、分钟级（天）、5分钟级（天）、小时级（天）、天级（天）、月级（天）
   - **负载监控**：实时归档（小时）、分钟级（天）、小时级（天）
   - **带宽统计**：小时槽位数量、天级槽位数量、月级槽位数量
   - **AI报告**：保留时长（天）
3. **可选**：点击"应用推荐"按钮应用系统推荐的保留策略
4. 点击"保存配置"按钮保存配置

### 执行数据清理
1. 在"数据清理管理"卡片中选择清理时间范围（如"30天前"）
2. 选择要清理的数据类型：
   - 勾选"TCPing监控数据"可以选择具体表（分钟级、5分钟级、小时级、天级、月级、归档）
   - 勾选"Load负载数据"可以选择具体表（分钟级、小时级、归档）
   - 勾选"Traffic流量数据"
   - 勾选"系统日志"可以选择具体表（审计日志等）
3. 点击"执行清理"按钮
4. 系统会先自动备份数据，然后执行清理
5. 清理完成后会显示清理结果

### 干跑清理（预览清理效果）
1. 在"维护操作"区域点击"干跑清理"按钮
2. 系统会显示预计删除的数据量，不会实际删除数据
3. 根据预览结果决定是否执行实际清理

### 优化数据库
1. 在"维护操作"区域点击"优化数据库"按钮
2. 系统会执行VACUUM和ANALYZE操作，提升查询效率
3. 优化操作可能需要一些时间，请耐心等待

## ⚠️ 注意事项

- **性能模式**：性能模式会立即写入配置；如手动调整了详细轮询参数，建议保存后重启以完全生效
- **PostgreSQL配置**：
  - PostgreSQL用于读取优化，所有写入仍使用SQLite
  - 配置保存后需要重启应用才能生效
  - PostgreSQL连接失败时会自动降级到SQLite
  - 配置信息存储在SQLite中，重启安全
- **数据迁移**：
  - 数据迁移可能需要较长时间，取决于数据量
  - 迁移过程中请勿关闭应用
  - 迁移完成后PostgreSQL会自动生效
- **数据清理**：
  - 清理前系统会自动备份数据
  - 清理操作不可逆，请谨慎选择清理范围
  - 建议先使用"干跑清理"预览清理效果
- **存储预警**：预警阈值设置后，系统会在达到阈值时自动发送通知

## 💡 使用建议

- **性能模式选择**：
  - **节能模式**：显著拉长轮询与推送间隔（轮询间隔10秒，WebSocket间隔12秒），最大限度减少CPU与网络消耗。适合资源紧张的边缘节点、单板机、移动网络环境，或对实时性要求不高的场景
  - **平衡模式**：在响应速度与系统开销之间取得平衡（轮询间隔3秒，WebSocket间隔4秒）。日常监控推荐值，适合常规服务器或虚拟化环境
  - **高性能模式**：缩短轮询与推送间隔以提升监控灵敏度（轮询间隔1.5秒，WebSocket间隔2秒），需承担更高的资源成本。适合生产集群、核心业务或对实时性要求极高的场景
  - **说明**：性能模式影响服务器查询探针的轮询间隔和WebSocket推送更新的间隔。选择依据主要是资源限制和实时性要求，节点数量较多时推荐使用平衡或节能模式。
- **数据保留策略**：
  - 根据服务器数量和存储容量设置合理的保留时长
  - 使用"应用推荐"功能获取系统推荐的保留策略
  - 定期检查数据库大小，及时调整保留策略
- **PostgreSQL使用**：
  - 适合数据量大、查询频繁的环境
  - 建议在数据量较小时就开始使用PostgreSQL，避免后续迁移数据量过大
- **定期维护**：
  - 定期执行数据清理，避免数据库过大
  - 定期优化数据库，提升查询性能
  - 关注存储预警通知，及时处理存储问题

