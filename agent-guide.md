# Agent 使用指南

## 什么是 Agent（探针）？

Agent（探针）是 DStatus 监控系统的核心组件，安装在被监控服务器上，负责收集和上报服务器的运行状态数据（CPU、内存、磁盘、网络等）。

## 安装方式

### 方式一：自动发现（推荐）

通过自动发现功能快速部署 Agent，适合批量添加服务器。

**操作步骤**：
1. 管理后台 → **自动发现** → 生成注册密钥
2. 在目标服务器执行页面自动生成的安装命令
3. 服务器自动注册（如启用审核则需手动批准）

**配置选项**：
- **需要密钥**：启用后需提供密码注册
- **需要审核**：启用后需管理员审核
- **主动上报**：Agent 主动推送数据（适合无公网 IP 的服务器）
- **自定义端口**：修改通信端口（面板默认 9999）

详见：[自动发现页面文档](/autodiscovery)

### 方式二：手动添加

通过服务器管理页面添加单个服务器。

**操作步骤**：
1. 管理后台 → **服务器管理** → **新增服务器**
2. 填写 SSH 信息（IP、端口、用户名、密码）
3. 测试连接 → 保存 → **安装探针**

详见：[服务器管理页面文档](/server-management)

### 方式三：命令行手动安装

适用于无法通过面板安装的场景（如无SSH权限、特殊网络环境等）。

你需要先拿到 Agent 二进制文件，然后启动运行。你可以用两种方式：

- 用 `config.yaml` 配置文件（适合长期运行）
- 直接用启动参数（适合临时测试/排障）

端口以“面板生成的安装命令/配置”为准（面板默认 9999）。如果你直接运行 Agent 二进制且不指定端口，程序默认会监听 `8080`。

详细步骤请参考：
- [Windows 运行教程](/Agent-Windows运行教程)
- [OpenWrt 运行教程](/Agent-OpenWrt运行教程)

## 卸载 Agent

### 通过面板卸载（推荐）

DStatus 面板提供了自动生成的卸载命令。

**操作步骤**：
1. 管理后台 → **服务器管理**
2. 找到要卸载的服务器，点击 **编辑**
3. 查看并复制 **卸载命令**
4. 在目标服务器执行卸载命令
5. 返回面板，点击 **删除记录**

### 手动卸载

如果无法使用面板的卸载命令，可参考以下步骤手动清理。

#### OpenWrt 系统

```bash
# 停止服务
/etc/init.d/dstatus stop
/etc/init.d/dstatus disable

# 删除文件
rm -f /etc/init.d/dstatus
rm -f /opt/dstatus*
# 删除配置（如你手动创建过）
rm -rf /etc/dstatus-agent
```

#### Windows 系统

```powershell
# 停止进程
taskkill /F /IM dstatus_windows_amd64.exe

# 删除任务计划（如果配置了自启动）
schtasks /Delete /TN "DStatus" /F

# 删除安装目录（根据实际路径修改）
Remove-Item -Path "C:\dstatus" -Recurse -Force
```

## 通信模式说明

Agent 支持两种通信模式，可在服务器编辑页面切换。

### 被动模式（默认）

- **工作原理**：服务器主动查询 Agent，Agent 被动等待请求
- **端口要求**：必须开放通信端口（以你配置为准；面板默认 9999）
- **适用场景**：服务器可以直接访问 Agent 的网络环境
- **离线检测**：通过查询失败判断节点是否离线

### 主动模式

- **工作原理**：Agent 主动向服务器上报数据
- **端口要求**：默认不需要开放端口（网络质量检测功能除外）
- **适用场景**：Agent 在内网或防火墙后，服务器无法直接访问的场景
- **离线检测**：通过心跳机制判断，超过阈值未收到上报则判定离线

注意：主动模式下无法监控其他目标服务器的网络质量

## 常见问题

### 服务器显示离线

1. 检查网络连通性
2. 检查 Agent 进程：`ps aux | grep dstatus`
3. 检查防火墙是否放行通信端口（以你配置为准；面板默认 9999）
4. 重新执行安装命令

### Agent 无法连接到服务器

**被动模式**：
- 确认通信端口已开放（以你配置为准；面板默认 9999）
- 检查防火墙规则
- 确认启动参数里的 `key` 填写正确

**主动模式**：
- 确认启动参数里的 `report-server` 是面板地址
- 确认 `report-key` 与面板配置一致
- 确认 `server-id` 填写正确（节点 SID）

### 如何更新 Agent 版本

1. 下载最新版本的 Agent 二进制文件
2. 停止当前运行的 Agent 进程
3. 替换旧的二进制文件
4. 重新启动 Agent

## 相关文档

- [使用指南](/usage) - 快速上手指南
- [自动发现](/autodiscovery) - 自动发现功能详细说明
- [服务器管理](/server-management) - 服务器管理操作指南
- [Windows 运行教程](/Agent-Windows运行教程) - Windows 系统手动安装配置
- [OpenWrt 运行教程](/Agent-OpenWrt运行教程) - OpenWrt 系统手动安装配置
